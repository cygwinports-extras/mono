inherit mono

DESCRIPTION="Mono C-Sharp runtime"

SRC_URI+=" etc-mono-config"
PATCH_URI="
	2.10-cygwin.patch
	2.10-check-funcs.patch
	2.10-no-undefined.patch
	2.4-dolt.patch
	2.4-libtool22.patch
	2.8-eglib-cygwin.patch
	2.10-libgc-cygwin.patch
"

DIFF_EXCLUDES="mcs *.css *.html"

# mono can't take anything too fancy, but does need the latter
CFLAGS="-O2 -pipe -fno-strict-aliasing"
CPPFLAGS+=" -I/usr/include/ncurses"

src_compile() {
	cd ${S}
	cygautoreconf

	cd ${B}
	cygconf \
		--with-gc=included \
		--with-libgdiplus=installed \
		--with-moonlight=no \
		--with-static_mono=no \
		--with-tls=pthread \
		--with-xen_opt=no
	cygmake -j1 EXTERNAL_MCS=false EXTERNAL_MONO=false PLATFORM=linux
}

src_test() {
	mkdir -p "${T}/home/mono"

	export HOME="${T}/home/mono"
	export XDG_CONFIG_HOME="${T}/home/mono"
	export XDG_DATA_HOME="${T}/home/mono"

	cd ${B}
	cygcheck
}

src_install() {
	cd ${B}
	cyginstall -j1 EXTERNAL_MCS=false EXTERNAL_MONO=false PLATFORM=linux

	cygmake -C ${S}/mcs/jay uninstall DESTDIR=${D}

	insinto /etc/mono
	newins ${S}/etc-mono-config config

	# dllmaps handled in master config
	rm -f ${D}/usr/lib/mono/2.0/mono-shlib-cop.exe.config

	sed -i -e 's!shouldnotlink=no!shouldnotlink=yes!' ${D}/usr/lib/libMono*.la

	dosym mono-nunit.pc /usr/lib/pkgconfig/nunit.pc

	# FIXME: AOT not working yet
#	export MONO_PATH=${D}/usr/lib/mono/1.0
#	for dll in ${D}/usr/lib/mono/1.0/mscorlib.dll \
#	           $(find ${D}/usr/lib/mono/1.0/ -name '*.dll' -o -name '*.exe')
#	do
#		if ${D}/usr/bin/mono --aot -O=all --config ${D}/etc/mono/config ${dll} &> /dev/null
#		then
#			inform "AOT compiling ${dll#${D}}: Success"
#		else
#			warning "AOT compiling ${dll#${D}}: ERROR"
#		fi
#	done
}
